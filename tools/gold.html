<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
	<title>Helgasoft - gold price with R</title>
	<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
	<meta name="description" content="Gold price with R">

		<!-- Mobile Metas -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<!-- Libs and Plugins CSS -->
	<link rel="stylesheet" href="../inc/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="../css/style.css">
	<link rel="stylesheet" href="../css/mobile.css">
	
	<!-- Skin CSS -->
	<link rel="stylesheet" href="../css/skin/night-purple.css">

	<script src='../js/papaparse.min.js'></script>
	<script src="https://www.gstatic.com/charts/loader.js"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.0/css/ion.rangeSlider.min.css"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.0/js/ion.rangeSlider.min.js"></script>
	<style>
		.dfilter_mobile { display:none }
	</style>

</head>

<body data-target="#main-navbar">   
    	<div class="body">
	<!--========== BEGIN HEADER ==========-->
	<header id="header" class="header-main">
	
	<!-- Begin Navbar -->
	<nav id="main-navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">
	
	  <div class="container">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle " data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
	        <a class="page-scroll" href="../#portfolio-section" style='color:white'>BACK</a>
	      </button>
	      <a class="navbar-brand page-scroll" href="../"></a>
	    </div>
	
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
	        <li><a class="page-scroll" href="../#portfolio-section">Back</a></li>
			</ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container -->
	</nav>
	<!-- End Navbar -->
	
	</header>
	<!-- ========= END HEADER =========-->

<div class="container">
<p>&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></p>
<h2>Gold price plot </h2>
<p>
Gold is traded on many exchanges all over the world, but the largest ones setting the price of the metal, are three - New York, London and Shanghai. Below is a graph with gold prices from these exchanges. Shanghai(<a href='http://www.en.sge.com.cn/'>SGE</a>) is trading in physical metal, while New York(<a href='http://www.cmegroup.com/'>Comex</a>) and London(<a href='https://www.lme.com/'>LME</a>) are trading primarily in "paper" gold (ETFs).  Daily price difference between Shanghai and New York is displayed on the bottom in <span style='color:red'>red</span>. Also depicted are important events with probable price impact, in <span style='color:powderblue'>blue</span>. 
</p>

<b>1) with R</b><p>
The graph was generated by an R application referencing libraries <i>xts, rvest, dplyr</i>. 
Data was obtained via web data extraction from <a href='https://www.kitco.com/'>kitco.com</a>, <a href='http://www.en.sge.com.cn/'>SGE</a> and other sources. Gold prices are calculated using USD-to-Yuan exchange rates. 
Webkit <a href='http://phantomjs.org/'>phantomjs</a> was also used to handle some web page Ajax calls.
</p>
<br />
  <a href='../img/sge-gold.png'><img id="myPng" src='../img/sge-gold.png' alt='gold price' width=550px Xheight=262px></a>
<br />&nbsp;<br />

<b>2) with Google Charts</b>
<p>Below is a <b>live</b> interactive chart showing the same data. Made with the <a href='https://developers.google.com/chart/'>Google Charts</a> javascript library, it features date range selection, area zoom, auto-resize, tooltips and event annotations. On mobile devices the date range control is implemented with <a href='https://github.com/IonDen/ion.rangeSlider'>ion.rangeSlider</a>.
</p>
<br />
<div id="dashboard">
  <div id="chart_line"></div>
  <div id="chart_difference"></div>
  <div id="chart_control_range"></div>
  <div class='dfilter_mobile'>
  	<input type="text" class="js-range-slider" name="my_range" value="" />
  </div>
</div>
<br />&nbsp;<br />

<h2>Stock price support</h2>
<p>
An example of time series data analysis. <br />
Stock closing prices are taken from a PostgreSQL database and local minimums are calculated. If similar values are found, they could represent a price support line. 
Extending support lines to the present day could help identify trading opportunities. 
The animated picture below shows several Dow stocks (<a href=https://www.bloomberg.com/quote/UTX:US>UTX</a>, <a href=https://www.bloomberg.com/quote/PG:US>PG</a>, <a href=https://www.bloomberg.com/quote/NKE:US>NKE</a>, <a href=https://www.bloomberg.com/quote/JPM:US>JPM</a>, <a href=https://www.bloomberg.com/quote/INTC:US>INTC</a>, <a href=https://www.bloomberg.com/quote/HD:US>HD</a>) in 2018 with horizontal price support lines drawn between significant price minimums.<br />
<!--Likewise, calculating price maximums would define resistance lines.-->
</p>
<br />

  <img id="myGif" src='../img/support.gif' alt='price support lines'>

<br />&nbsp;<br />&nbsp;
<h2>Crypto order fill</h2>
<p>
The purpose of this project was to show how a cryptocurrency buy order is filled in real-time.
Typically a large buy order is sent to multiple exchanges simultaneously for faster execution. 
Responses from those exchanges are monitored in real-time and presented in a dynamic chart.<br />
The graphical part was implemented with library D3.js.
</p>
<p>&nbsp;</p>

  <img src='../img/btc.gif' alt='crypto order fill'>

<p>&nbsp;</p>
<div class='tcenter'>&copy; helgasoft.com</div>
<p>&nbsp;</p>
<p>&nbsp;</p>

</div>
</div>  <!-- end body -->
<script type="text/javascript">

google.charts.load('current', {
  callback: function () { 
  	window.addEventListener('resize', loadGraph, false); // auto-resize
  	loadGraph(); 
  },
  packages:['controls', 'corechart']
});

var is_mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
var controlRangeFilter = chartLine = chartClmn = null;
var labelColor = '#676767';

function dateToTS (date) {
	return date.valueOf();
}

function tsToDate (ts) {
	var d = new Date(ts);
	return d.toLocaleDateString('en-US', {
	    year: 'numeric',
	    month: 'short',
	    day: 'numeric'
	});
}

function loadGraph() {

	var dataChart = new google.visualization.DataTable();
	dataChart.addColumn('date', 'dte');
	dataChart.addColumn('number', 'SGE');
	dataChart.addColumn('number', 'XAU');
	dataChart.addColumn('number', 'London');
	dataChart.addColumn({id: 'ano', type: 'string', role: 'annotation'});
	dataChart.addColumn('number', 'disparity SGE-XAU');

	var firstd = lastd = startd = new Date();
	
	chartLine = new google.visualization.ChartWrapper({
		chartType: 'LineChart',
		containerId: 'chart_line',
		dataTable: dataChart,
		view: { columns: [0,1,2,3,4] },
		options: {
		 animation: {
		   duration: 400,
		   easing: 'linear',
		   startup: true
		 }
		 ,height: 340
		 ,colors: ['orange','forestgreen','orchid','powderblue']
		 ,chartArea: { backgroundColor: '#eeeeee' }
		 ,legend: {
		   textStyle: { fontSize: 12, color: labelColor }
		 }
		 ,series: {
		   0: {
		     pointShape: { type: 'circle' },  //type: 'star', sides: 4, dent: 0.3
		     pointSize: 3,
		     pointsVisible: true,
		     type: 'line'
		   }
		 } 
		 ,theme: 'maximized'
		 ,title: 'Gold Price $US/oz'
		 ,titleTextStyle: {
		   color: labelColor,
		   bold: true,
		   fontSize: 12
		 }
		 ,hAxis: { //format:'MMM d, y' }
		 	gridlines: { units: { months: {format: ["MMM"]} } }
		 }
		 ,vAxis: { format: '$#,##0' }
		 ,tooltip: { isHtml: true, textStyle: { fontSize: 10 } }
		 ,focusTarget: 'category'
		 ,annotations: { 
		 	style: 'line',
			stem: { color: labelColor },
			textStyle: { color: labelColor }
		 }
		 ,explorer: { actions: ['dragToZoom', 'rightClickToReset'] },  
		}
	});

        chartClmn = new google.visualization.ChartWrapper({
            chartType: 'ColumnChart',
            containerId: 'chart_difference',
            dataTable: dataChart,
            view: {columns: [0, 5]},
            options: {
	 	theme: 'maximized'
	 	,height: 120                    
		,hAxis: { textPosition: 'none' }  // =disable
		,vAxis: { ticks: [-20,20,40,60], format: "$##", viewWindow: { min:-25 } }  //, minValue: -25
		,chartArea: { backgroundColor: '#eeeeee' }
		,colors: ['red']
            }
        });

	controlRangeFilter = new google.visualization.ControlWrapper({
		controlType: 'ChartRangeFilter',
		containerId: 'chart_control_range',
		options: {
			filterColumnIndex: 0,
			ui: {
				chartType: 'AreaChart',
    				chartView : { columns : [ 0, 2, 4 ] },
				chartOptions: {				  
				  chartArea: {
				    left: 0,
				    width: '100%'
				  },
				  colors: ['orange','forestgreen','brown','powderblue', '#E53935', '#43A047', '#FFB300','orchid'],
				  annotations: {
				    stem: { color: 'magenta' /*,length: 30 */ }
				    ,textStyle: { fontSize: 10, color: 'black'} //'transparent'
				  },
				  height: 66,
				  width: '100%'
			    	}
			    }
			}
	});

	var dashboard = new google.visualization.Dashboard(document.getElementById('dashboard'));
	dashboard.bind(controlRangeFilter, [chartLine, chartClmn]);
	
	Papa.parse('gold.csv', { download: true, header: true, complete: completeFn });  // async
	
	function completeFn(results) {
		if (results && results.errors)
		{
			if (results.errors)
			{
				errorCount = results.errors.length;
				firstError = results.errors[0];
			}
			if (results.data && results.data.length > 0)
				rowCount = results.data.length;
		}
		console.log("  Data rows:", rowCount); //, '  err.count=',errorCount);
		results.data.forEach(function (r) {
			dataChart.addRow([ new Date(r.date+' '), 
				Number(r.sge), Number(r.xau), Number(r.lon), 
				(r.ano=='' ? null : r.ano), 
				parseFloat(r.sge)-Number(r.xau) ]);
		});
	
		// create number formatter
		var formatter = new google.visualization.NumberFormat({
			prefix: '$'	//,negativeParens: true
		});
		formatter.format(dataChart, 1);  // format data columns
		formatter.format(dataChart, 5);
	
		// draw dashboard
		firstd = new Date(results.data[0].date);
		lastd = new Date(results.data[results.data.length-1].date);
		startd = new Date(lastd.getTime() - (24*60*60*1000) * 180) // 180 days prior
		controlRangeFilter.setState({
		   range: {
			start: startd,
			end: lastd
		   }
		});
		dashboard.draw(dataChart);
		
		$(".js-range-slider").ionRangeSlider({
		    type: "double",
		    grid: true,
		    drag_interval: true,
		    min: dateToTS(firstd),
		    max: dateToTS(lastd), 
		    from: dateToTS(startd),
		    to: dateToTS(lastd),
		    prettify: tsToDate
		});
	}

}

var observer = new MutationObserver(function () {
	// beautify annotations as timeline events
	var recs = document.getElementById('chart_line').getElementsByTagName('rect');
	Array.prototype.forEach.call(recs, function(rect) {
	        if (rect.getAttribute('fill') === labelColor) {
		  rect.setAttribute('width', '20');
		  rect.setAttribute('y', "0");
		  rect.setAttribute('height', "340");
		  rect.setAttribute('fill', "powderblue");
		  rect.setAttribute('fill-opacity', "0.5");
	        }
	});
});
var chartDiv = document.getElementById('chart_line');
observer.observe(chartDiv, {
	childList: true,
	subtree: true
});

// ChartRangeFilter doesn't work on mobile. Use ionRangeSlider to manipulate range
if (is_mobile)
{
	$('#chart_control_range').hide();
	$('.dfilter_mobile').toggle();
	$('.js-range-slider').on("change", function () {
		var $inp = $(this);
		var ival = $inp.prop("value").split(';'); // reading input value
		controlRangeFilter.setState({range: { start: new Date(Number(ival[0])), end: new Date(Number(ival[1])) }});
		controlRangeFilter.draw();
	});
}

/*
function resize1() {
	// canvas must cover full width of screen regardless of the resolution
	var png = document.getElementById('myPng');
	var width = window.innerWidth - 80;
	if (width > png.naturalWidth) width = png.naturalWidth;
	
	// calculate the proper scaled height to work with every resolution
	var ratio =  png.naturalHeight / png.naturalWidth;
	var height = width * ratio;
	
	png.width = width;
	png.height = height; 
}
window.addEventListener('load', resize1, false);
window.addEventListener('resize', resize1, false); */
    </script>
</body>
</html>