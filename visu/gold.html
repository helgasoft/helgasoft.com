<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
	<title>Helgasoft - gold price with R</title>
	<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
	<meta name="description" content="Gold price with R">

		<!-- Mobile Metas -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<!-- Libs and Plugins CSS -->
	<link rel="stylesheet" href="../inc/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="../css/style.css">
	<link rel="stylesheet" href="../css/mobile.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.0/css/ion.rangeSlider.min.css"/>
	
	<!-- Skin CSS -->
	<link rel="stylesheet" href="../css/skin/night-purple.css">

	<script src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.0/js/ion.rangeSlider.min.js"></script>
	<style>
		.dfilter_mobile { display:none }
	</style>

</head>

<body data-target="#main-navbar">   
    	<div class="body">
	<!--========== BEGIN HEADER ==========-->
	<header id="header" class="header-main">
	
	<!-- Begin Navbar -->
	<nav id="main-navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">
	
	  <div class="container">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle " data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
	        <a class="page-scroll" href="../#portfolio-section" style='color:white'>BACK</a>
	      </button>
	      <a class="navbar-brand page-scroll" href="../"></a>
	    </div>
	
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
	        <li><a class="page-scroll" href="../#portfolio-section">Back</a></li>
			</ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container -->
	</nav>
	<!-- End Navbar -->
	
	</header>
	<!-- ========= END HEADER =========-->

<div class="container">
<p>&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></p>
<h2>Gold price plot </h2>
<p>
Gold is traded on many exchanges all over the world, but the largest ones setting the price of the metal, are three - New York, London and Shanghai. Below is a graph with gold prices from these exchanges. Shanghai(<a href='http://www.en.sge.com.cn/'>SGE</a>) is trading in physical metal, while New York(<a href='http://www.cmegroup.com/'>Comex</a>) and London(<a href='https://www.lme.com/'>LME</a>) are trading primarily in "paper" gold (ETFs).  Daily price difference between Shanghai and New York is displayed on the bottom in <span style='color:red'>red</span>. Also depicted are important events with probable price impact, in <span style='color:powderblue'>blue</span>. 
</p>

<h4>1) made with R</h4><p>
The graph was generated by an R application referencing libraries <i>xts, rvest, dplyr</i>. 
Data was obtained via web data extraction from <a href='https://www.kitco.com/'>kitco.com</a>, <a href='http://www.en.sge.com.cn/'>SGE</a> and other sources. Gold prices are calculated using USD-to-Yuan exchange rates. 
Webkit <a href='http://phantomjs.org/'>phantomjs</a> was also used to handle some web page Ajax calls.
</p>
<br />
  <a href='../img/sge-gold.png'><img id="myPng" src='../img/sge-gold.png' alt='gold price' width=550px Xheight=262px></a>
<br />&nbsp;<br />
<!--   API changes too often:
<b>2) made with <a href='https://developers.google.com/chart/'>Google Charts</a></b>
<p>Below is a <b>live</b> interactive chart showing the same data. It features date range selection, area zoom, auto-resize, tooltips and event annotations. On mobile devices the date range control is implemented with <a href='https://github.com/IonDen/ion.rangeSlider'>ion.rangeSlider</a>. Weekend days are included by default.
</p>
<br />
<div id="dashboard">
  <div id="chart_line"></div>
  <div id="chart_difference"></div>
  <div id="chart_control_range"></div>
  <div class='dfilter_mobile'>
  	<input type="text" class="js-range-slider" name="my_range" value="" />
  </div>
</div>
<br />&nbsp;<br />
 -->

 <br />
<h4>2) made with <a href='https://echarts.apache.org/en/index.html'>ECharts</a></h4>
<p>A <b>live</b> interactive chart featuring date range selection, area zoom, auto-resize, tooltips, annotations, show/hide series and image download.
</p>
<br />
<div id="echart" style="height:90%; width:100%; min-height: 650px;"></div>
<br />&nbsp;<br />

<h2>Stock price support</h2>
<p>
An example of time series data analysis. <br />
Stock closing prices are taken from a PostgreSQL database and local minimums are calculated. If similar values are found, they could represent a price support line. 
Extending support lines to the present day could help identify trading opportunities. 
The animated picture below shows several Dow stocks (<a href=https://www.bloomberg.com/quote/UTX:US>UTX</a>, <a href=https://www.bloomberg.com/quote/PG:US>PG</a>, <a href=https://www.bloomberg.com/quote/NKE:US>NKE</a>, <a href=https://www.bloomberg.com/quote/JPM:US>JPM</a>, <a href=https://www.bloomberg.com/quote/INTC:US>INTC</a>, <a href=https://www.bloomberg.com/quote/HD:US>HD</a>) in 2018 with horizontal price support lines drawn between significant price minimums.<br />
<!--Likewise, calculating price maximums would define resistance lines.-->
</p>
<br />

  <img id="myGif" src='../img/support.gif' alt='price support lines'>

<br />&nbsp;<br />&nbsp;
<h2>Crypto order fill</h2>
<p>
The purpose of this project was to show how a cryptocurrency buy order is filled in real-time.
Typically a large buy order is sent to multiple exchanges simultaneously for faster execution. 
Responses from those exchanges are monitored in real-time and presented in a dynamic chart.<br />
The graphical part was implemented with library D3.js.
</p>
<p>&nbsp;</p>

  <img src='../img/btc.gif' alt='crypto order fill'>

<p>&nbsp;</p>
<div class='tcenter'>&copy; helgasoft.com</div>
<p>&nbsp;</p>
<p>&nbsp;</p>

</div>
</div>  <!-- end body -->
<script type="text/javascript">
	let dataChart, dashboard;
	let dom = document.getElementById("echart");
	let myChart = echarts.init(dom);

google.charts.load('current', {
  callback: function () { 
  	window.addEventListener('resize', loadGraph, false); // auto-resize
  	loadGraph(); 
  },
  packages:['controls', 'corechart']
});

let is_mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
let controlRangeFilter = gooChart = chartClmn = null;
let labelColor = '#676767';

function dateToTS (date) {
	return date.valueOf();
}

function tsToDate (ts) {
	let d = new Date(ts);
	return d.toLocaleDateString('en-US', {
	    year: 'numeric',
	    month: 'short',
	    day: 'numeric'
	});
}
function completeFn(results) {
	if (results && results.errors)
	{
		if (results.errors)
		{
			errorCount = results.errors.length;
			firstError = errorCount>0 ? results.errors[0].message : '';
		}
		if (results.data && results.data.length > 0)
			rowCount = results.data.length;
	}
	console.log("  Data rows:", rowCount, (errorCount ? '(errs='+errorCount+')'+' '+firstError : '')); 

	let cdata = [], marks = [], inArea = false, tmp;	// for ECharts
	results.data.forEach(function (r) {
		dataChart.addRow([ new Date(r.date+' '), 
			Number(r.sge), Number(r.xau), Number(r.lon), 
			(r.ano=='' ? null : r.ano), 
			parseFloat(r.sge)-Number(r.xau) ]);

		// echarts
        cdata.push([ r.date, 
				Number(r.sge), Number(r.xau), Number(r.lon), 
                Math.round(parseFloat(r.sge)-Number(r.xau),2) ]);
            // build annotations
		if (r.ano!='') {
                if (!inArea) {
                    inArea = true;
                    tmp = { xAxis: r.date, name: r.ano, 
                        label: { show: true, color: '#000', rotate:90, position: 'insideTopLeft', 
								offset:[-r.ano.length*9, 1]},
                        itemStyle: {color: '#68d2e0', opacity: 0.3}
                    }; //start
                }
		} else if (inArea) {
                inArea = false;
                marks.push( [tmp, {xAxis: r.date}] ); //end
		}
	});
	if (inArea) marks.push( [tmp, {xAxis: results.data[results.data.length-1].date}] );

	// create number formatter
	let formatter = new google.visualization.NumberFormat({
		prefix: '$'	//,negativeParens: true
	});
	formatter.format(dataChart, 1);  // format data columns
	formatter.format(dataChart, 5);

	// draw dashboard
	firstd = new Date(results.data[0].date);
	lastd = new Date(results.data[results.data.length-1].date);
	startd = new Date(lastd.getTime() - (24*60*60*1000) * 180) // 180 days prior
	controlRangeFilter.setState({
	   range: {
		start: startd,
		end: lastd
	   }
	});
	dashboard.draw(dataChart);
	
	$(".js-range-slider").ionRangeSlider({
	    type: "double",
	    grid: true,
	    drag_interval: true,
	    min: dateToTS(firstd),
	    max: dateToTS(lastd), 
	    from: dateToTS(startd),
	    to: dateToTS(lastd),
	    prettify: tsToDate
	});

	// ECharts

	option = {
        title: { text: 'Gold Price $US/oz' },
        toolbox: {
            left: 'center',
            feature: { 
                saveAsImage: { title: 'save as .png'},
                dataZoom: { title: {zoom: 'set zoom area', back: 'restore zoom'} }
            }
        },
        legend: {
            right: 20,
            data: ['SGE', 'XAU', 'London'],
            selected: { 'SGE': true, 'XAU': true, 'London': false }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross', animation: false },
            backgroundColor: 'rgba(245, 245, 245, 0.8)',
            borderWidth: 1,
            borderColor: '#ccc',
            padding: 10,
            textStyle: { color: '#000' },
            formatter: function(params) {
                let parts = params[0].name.split('-').map(Number);
                let res = new Date(parts[0],parts[1]-1,parts[2]).toDateString();
                for (let i = 0, l = params.length; i < l; i++) {
                    res += '<li style="list-style:none">' + params[i].marker + params[i].seriesName + ': ' + echarts.format.addCommas(params[i].value);
                }
                return res;
            }
        },
        axisPointer: {
            link: {xAxisIndex: 'all'}
        },
        dataZoom: [
            {
                show: true,
                realtime: true,
                start: 60, end: 100,
                xAxisIndex: [0, 1]
            },
            {
                type: 'inside',
                realtime: true,
                start: 60, end: 100,
                xAxisIndex: [0, 1]
            }
        ],
        grid: [{
            show: true,
            //backgroundColor: '#F5FACD80', //'rgba(128, 128, 128, 0.5)',
            backgroundColor: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(245, 250, 205, 0.10)' },
                            { offset: 1, color: 'rgba(245, 250, 205, 1.00)' } ]),
            left: 50, right: 50,
            height: '70%'
        }, {
            left: 50, right: 50,
            top: '82%',
            //height: '20%'
        }],
        xAxis: [
            { 
                type: 'category',
                data: cdata.map(function(v,i) { return v[0]; }),  
                boundaryGap: false,
                axisLine: {onZero: true}
            },
            { 
                gridIndex: 1,
                type: 'category',
                data: cdata.map(function(v,i) { return v[0]; }),
                boundaryGap: false,
                axisLine: { onZero: true},
                axisLabel: { show: false },
                name: 'disparity SGE-XAU',
                nameLocation: 'center',
                nameGap: 3
             }
        ],
        yAxis: [{ 
                type: 'value',
                scale: true
           },
            {
                gridIndex: 1,
                type: 'value'
            }
        ],
        color: ['orange','forestgreen','orchid','red','powderblue'],
        series: [{
            name: 'SGE', type: 'line',
            data: cdata.map(function(v,i) { return v[1]; }),
            symbolSize: 5, z: 4,
            itemStyle: { opacity: 0.4 },
            markArea: { silent: true, data: marks }
        },{
            name: 'XAU', type: 'line',
            data: cdata.map(function(v,i) { return v[2]; }),
            symbolSize: 5, z: 3,
            itemStyle: { opacity: 0.4 }
        },{
            name: 'London', type: 'line',
            data: cdata.map(function(v,i) { return v[3]; }),
            symbolSize: 5, z: 2,
            itemStyle: { opacity: 0.4 }
        },
        {
            name: 'SGE-XAU', type: 'bar',
            xAxisIndex: 1, yAxisIndex: 1,
            symbolSize: 5,
            hoverAnimation: false,
            data: cdata.map(function(v,i) { return v[4]; })
        }
        ]
    };

    if (option && typeof option === "object") {
        myChart.setOption(option, true);
    }
}	// completeFn

function loadGraph() {
	if(myChart != null && myChart != undefined) myChart.resize();	// echarts

	dataChart = new google.visualization.DataTable();
	dataChart.addColumn('date', 'dte');
	dataChart.addColumn('number', 'SGE');
	dataChart.addColumn('number', 'XAU');
	dataChart.addColumn('number', 'London');
	dataChart.addColumn({id: 'ano', type: 'string', role: 'annotation'});
	dataChart.addColumn('number', 'disparity SGE-XAU');

	let firstd = lastd = startd = new Date();
	
	gooChart = new google.visualization.ChartWrapper({
		chartType: 'LineChart',
		containerId: 'chart_line',
		dataTable: dataChart,
		view: { columns: [0,1,2,3,4] },
		options: {
		 animation: { duration: 400, easing: 'linear', startup: true }
		 ,height: 340
		 ,colors: ['orange','forestgreen','orchid','powderblue']
		 ,chartArea: { backgroundColor: '#eeeeee' }
		 ,legend: {
		   textStyle: { fontSize: 12, color: labelColor }
		 }
		 ,series: {
		   0: {
		     pointShape: { type: 'circle' },  //type: 'star', sides: 4, dent: 0.3
		     pointSize: 3,
		     pointsVisible: true,
		     type: 'line'
		   }
		 } 
		 ,theme: 'maximized'
		 ,title: 'Gold Price $US/oz'
		 ,titleTextStyle: { color: labelColor, bold: true, fontSize: 12 }
		 ,hAxis: { //format:'MMM d, y' }
		 	gridlines: { units: { months: {format: ["MMM"]} } }
		 }
		 ,vAxis: { format: '$#,##0' }
		 ,tooltip: { isHtml: true, textStyle: { fontSize: 10 } }
		 ,focusTarget: 'category'
		 ,annotations: { style: 'line',	stem: { color: labelColor }, textStyle: { color: labelColor } }
		 ,explorer: { actions: ['dragToZoom', 'rightClickToReset'] },  
		}
	});

	chartClmn = new google.visualization.ChartWrapper({
	  chartType: 'ColumnChart',
	  containerId: 'chart_difference',
	  dataTable: dataChart,
	  view: {columns: [0, 5]},
	  options: {
		theme: 'maximized'
		,height: 100                    
		,hAxis: { textPosition: 'none' }  // =disable
		,vAxis: { format: "$##" } //ticks: [-120,-100,-20,20,40,60], viewWindow: { min:-25 } }  //, minValue: -25
		,chartArea: { backgroundColor: '#eeeeee' }
		,colors: ['red']
	  }
	});

	controlRangeFilter = new google.visualization.ControlWrapper({
		controlType: 'ChartRangeFilter',
		containerId: 'chart_control_range',
		options: {
			filterColumnIndex: 0,
			ui: {
				chartType: 'AreaChart',
    				chartView : { columns : [ 0, 2, 4 ] },
				chartOptions: {				  
				  chartArea: {
				    left: 0,
				    width: '100%'
				  },
				  colors: ['orange','forestgreen','brown','powderblue', '#E53935', '#43A047', '#FFB300','orchid'],
				  annotations: {
				    stem: { color: 'magenta' /*,length: 30 */ }
				    ,textStyle: { fontSize: 10, color: 'black'} //'transparent'
				  },
				  height: 66,
				  width: '100%'
			    	}
			    }
			}
	});

	dashboard = new google.visualization.Dashboard(document.getElementById('dashboard'));
	dashboard.bind(controlRangeFilter, [gooChart, chartClmn]);
	
	Papa.parse('gold.csv', { download: true, header: true, complete: completeFn });  // async
}

let observer = new MutationObserver(function () {
	// beautify annotations as timeline events
	let recs = document.getElementById('chart_line').getElementsByTagName('rect');
	Array.prototype.forEach.call(recs, function(rect) {
	        if (rect.getAttribute('fill') === labelColor) {
		  rect.setAttribute('width', '20');
		  rect.setAttribute('y', "0");
		  rect.setAttribute('height', "340");
		  rect.setAttribute('fill', "powderblue");
		  rect.setAttribute('fill-opacity', "0.5");
	        }
	});
});
let chartDiv = document.getElementById('chart_line');
observer.observe(chartDiv, {
	childList: true,
	subtree: true
});

// ChartRangeFilter doesn't work on mobile. Use ionRangeSlider to manipulate range
if (is_mobile)
{
	$('#chart_control_range').hide();
	$('.dfilter_mobile').toggle();
	$('.js-range-slider').on("change", function () {
		let $inp = $(this);
		let ival = $inp.prop("value").split(';'); // reading input value
		controlRangeFilter.setState({range: { start: new Date(Number(ival[0])), end: new Date(Number(ival[1])) }});
		controlRangeFilter.draw();
	});
}


/*
function resize1() {
	// canvas must cover full width of screen regardless of the resolution
	let png = document.getElementById('myPng');
	let width = window.innerWidth - 80;
	if (width > png.naturalWidth) width = png.naturalWidth;
	
	// calculate the proper scaled height to work with every resolution
	let ratio =  png.naturalHeight / png.naturalWidth;
	let height = width * ratio;
	
	png.width = width;
	png.height = height; 
}
window.addEventListener('load', resize1, false);
window.addEventListener('resize', resize1, false); */
    </script>
</body>
</html>